from telegram import Update
from telegram.ext import ApplicationBuilder, MessageHandler, ContextTypes, filters
import requests
import re
from datetime import datetime
import os

from cities.py import iata_to_city

BOT_TOKEN = os.getenv("BOT_TOKEN")

IATA_TO_YANDEX = {
  "–ê–Ø–ù": "c22434",
  "–ë–ò–•": "c11236",
  "–ë–ù–ì": "c22834",
  "–í–ê–ì": "c23000",
  "–í–õ–ú": "c192",
  "–ñ–ï–ó": "c11264",
  "–ó–ï–Ø": "c11379",
  "–ó–õ–ê": "c22214",
  "–ö–ó–ß": "c22952",
  "–ö–ù–ö": "c11358",
  "–ö–°–ß": "c22967",
  "–ú–ê–ú": "c22208",
  "–ú–ó–ù": "c20114",
  "–ú–£–ñ": "c22228",
  "–ù–ò–ö": "c1139",
  "–û–û–õ": "c9623788",
  "–û–°–û": "c22393",
  "–û–°–£": "c23352",
  "–ü–ê–ô": "c20161",
  "–ü–ê–ù": "c22392",
  "–ü–ê–ß": "c9821894",
  "–°–ê–ì": "c22984",
  "–°–ë–û": "c21120",
  "–°–ö–†": "c11448",
  "–°–ú–•": "c24532",
  "–°–ú–ß": "c21116",
  "–•–ñ–†": "c24498",
  "–•–†–ü": "c9624040",
  "–Ø–ì–û": "c9880414",
  "–Ø–ú–ë": "c21754",
  "AAQ": "c1107",
  "AAR": "c26705",
  "ABA": "c1095",
  "ADD": "c20771",
  "AER": "c239",
  "AHB": "c29385",
  "ALA": "c22177",
  "ALG": "c20828",
  "AMS": "c10466",
  "ARH": "c20",
  "ASB": "c22168",
  "ASF": "c37",
  "ATH": "c10418",
  "ATL": "c86",
  "AUH": "c11498",
  "AYT": "c11511",
  "BAK": "c10253",
  "BAX": "c197",
  "BCN": "c10429",
  "BEG": "c10522",
  "BER": "c177",
  "BEV": "c129",
  "BGN": "c22205",
  "BGO": "c21079",
  "BGS": "c22026",
  "BGW": "c20573",
  "BHK": "c10330",
  "BHX": "c21134",
  "BJS": "c10590",
  "BKA": "c22183",
  "BKK": "c10620",
  "BLQ": "c10444",
  "BLR": "c21006",
  "BOM": "c10558",
  "BOS": "c223",
  "BQG": "c22441",
  "BQJ": "c22189",
  "BQS": "c77",
  "BQT": "c153",
  "BRE": "c10403",
  "BRU": "c10376",
  "BSL": "c22253",
  "BTK": "c976",
  "BTS": "c10489",
  "BUD": "c10398",
  "BUE": "c10133",
  "BUS": "c10278",
  "BZK": "c191",
  "CAI": "c11485",
  "CAN": "c21431",
  "CEE": "c968",
  "CEK": "c56",
  "CGK": "c10574",
  "CGN": "c98",
  "CJU": "c28377",
  "CKH": "c11441",
  "CMB": "c10633",
  "CMN": "c10138",
  "CNN": "c11437",
  "CPH": "c10425",
  "CSH": "c9752726",
  "CSY": "c45",
  "CTS": "c10642",
  "CWL": "c28584",
  "CYX": "c20822",
  "CZR": "c22196",
  "DAD": "c10543",
  "DEB": "c21466",
  "DEE": "c11449",
  "DEL": "c10562",
  "DHG": "c11411",
  "DKS": "c11345",
  "DLI": "c21448",
  "DLM": "c21445",
  "DLR": "c11412",
  "DMM": "c26930",
  "DNK": "c141",
  "DOK": "c142",
  "DPS": "c11513",
  "DPT": "c22190",
  "DRS": "c10407",
  "DTM": "c26601",
  "DTW": "c89",
  "DUB": "c10426",
  "DUS": "c10408",
  "DXB": "c11499",
  "DYR": "c11458",
  "DYU": "c10318",
  "DZN": "c10308",
  "EDI": "c10397",
  "EGO": "c4",
  "ELQ": "c26857",
  "ERG": "c11263",
  "ESL": "c1094",
  "ETL": "c41481",
  "EVN": "c10262",
  "EYK": "c11179",
  "EZV": "c22169",
  "FEG": "c10336",
  "FEK": "c22549",
  "FLR": "c10461",
  "FRA": "c100",
  "FRU": "c10309",
  "FUK": "c10644",
  "GDX": "c79",
  "GDZ": "c10990",
  "GLA": "c10389",
  "GME": "c155",
  "GOI": "c26812",
  "GOJ": "c23243",
  "GOY": "c21705",
  "GRV": "c1106",
  "GRZ": "c22296",
  "GVA": "c10514",
  "GVR": "c11456",
  "GYG": "c9633963",
  "HAG": "c21396",
  "HAJ": "c10405",
  "HAM": "c178",
  "HAN": "c10552",
  "HAV": "c10137",
  "HEL": "c10493",
  "HFA": "c132",
  "HKG": "c11514",
  "HKT": "c10622",
  "HMA": "c57",
  "HPH": "c29535",
  "HRB": "c10596",
  "HRG": "c11486",
  "HRK": "c147",
  "HTA": "c68",
  "HTG": "c11346",
  "HUI": "c20905",
  "IAA": "c11305",
  "IAR": "c16",
  "IEV": "c143",
  "IGT": "c20181",
  "IJK": "c44",
  "IKS": "c11440",
  "IKT": "c63",
  "INA": "c10941",
  "IRM": "c22170",
  "ISB": "c10614",
  "IST": "c11508",
  "ITU": "c9623660",
  "IWA": "c5",
  "JED": "c22250",
  "JMU": "c28694",
  "JNB": "c21438",
  "JOK": "c41",
  "KBL": "c10526",
  "KBV": "c20872",
  "KCK": "c11267",
  "KEJ": "c64",
  "KGD": "c22",
  "KGF": "c164",
  "KGP": "c11180",
  "KHI": "c1061",
  "KHV": "c76",
  "KIV": "c10313",
  "KJA": "c62",
  "KLF": "c6",
  "KMW": "c7",
  "KNY": "c20643",
  "KPW": "c22211",
  "KQT": "c10319",
  "KRK": "c10474",
  "KRO": "c53",
  "KRR": "c35",
  "KRW": "c10326",
  "KSQ": "c10331",
  "KSZ": "c10846",
  "KTM": "c10613",
  "KUF": "c51",
  "KUL": "c10604",
  "KVK": "c10894",
  "KVM": "c9655204",
  "KVR": "c11413",
  "KVX": "c46",
  "KWI": "c11496",
  "KXK": "c11453",
  "KYZ": "c11333",
  "KZN": "c43",
  "LBA": "c22302",
  "LCA": "c10421",
  "LDG": "c21851",
  "LED": "c2",
  "LEJ": "c10410",
  "LHE": "c10616",
  "LIS": "c10478",
  "LJU": "c10492",
  "LNZ": "c21163",
  "LON": "c10393",
  "LPK": "c9",
  "LPL": "c10392",
  "LUX": "c21204",
  "LWN": "c10259",
  "LWO": "c144",
  "LYS": "c10499",
  "MAD": "c10435",
  "MAN": "c10394",
  "MBX": "c31790",
  "MCT": "c21587",
  "MCX": "c28",
  "MED": "c28361",
  "MEL": "c21265",
  "MFM": "c28616",
  "MIL": "c10448",
  "MJY": "c22013",
  "MJZ": "c20115",
  "MLA": "c22264",
  "MLE": "c10605",
  "MMK": "c23",
  "MNL": "c10629",
  "MOW": "c213",
  "MPW": "c10366",
  "MQF": "c235",
  "MQJ": "c9623682",
  "MRS": "c10501",
  "MRU": "c24376",
  "MRV": "c11063",
  "MSQ": "c157",
  "MUC": "c99",
  "MVQ": "c158",
  "NAL": "c30",
  "NAP": "c10446",
  "NBC": "c236",
  "NBO": "c21312",
  "NCE": "c10500",
  "NCU": "c10337",
  "NEI": "c21140",
  "NGK": "c20267",
  "NHA": "c40246",
  "NJC": "c1091",
  "NLI": "c11454",
  "NLV": "c148",
  "NMA": "c21314",
  "NNM": "c10902",
  "NOJ": "c11231",
  "NOZ": "c237",
  "NQZ": "c163",
  "NSK": "c11311",
  "NTE": "c26700",
  "NUE": "c10412",
  "NUX": "c11230",
  "NYA": "c11186",
  "NYC": "c202",
  "NYM": "c11229",
  "NZG": "c21815",
  "ODO": "c11260",
  "ODS": "c145",
  "OGZ": "c33",
  "OHH": "c11447",
  "OHO": "c11455",
  "OKA": "c28815",
  "OLE": "c11439",
  "OLK": "c22199",
  "OMS": "c66",
  "OPO": "c10479",
  "OSA": "c10641",
  "OSL": "c10467",
  "OSS": "c9623570",
  "OSW": "c11091",
  "OTP": "c10487",
  "OVB": "c65",
  "OVS": "c11190",
  "PAR": "c10502",
  "PDV": "c10385",
  "PEE": "c50",
  "PES": "c18",
  "PEX": "c10942",
  "PEZ": "c49",
  "PKC": "c78",
  "PKV": "c25",
  "PLX": "c165",
  "PMO": "c10456",
  "PQC": "c29542",
  "PRG": "c10511",
  "PRN": "c21311",
  "PUS": "c10634",
  "PWE": "c1146",
  "PWQ": "c190",
  "PYJ": "c24534",
  "RAK": "c21258",
  "REK": "c10428",
  "REN": "c48",
  "RGK": "c11319",
  "RIX": "c11474",
  "ROM": "c10445",
  "ROV": "c39",
  "RRG": "c34790",
  "RTM": "c20755",
  "RTW": "c194",
  "RUH": "c23360",
  "RYB": "c10839",
  "RZH": "c9857033",
  "SBT": "c40067",
  "SCL": "c2096",
  "SCW": "c19",
  "SEA": "c91",
  "SEK": "c22220",
  "SEL": "c10635",
  "SES": "c10859",
  "SFO": "c90",
  "SGC": "c973",
  "SGN": "c10553",
  "SHA": "c10599",
  "SHJ": "c20843",
  "SIN": "c10619",
  "SIP": "c146",
  "SJJ": "c10387",
  "SKD": "c10334",
  "SKP": "c10463",
  "SKX": "c42",
  "SLY": "c58",
  "SOF": "c10379",
  "SPU": "c10508",
  "SSG": "c20820",
  "SSH": "c11487",
  "STO": "c10519",
  "STR": "c101",
  "STW": "c36",
  "SUH": "c22024",
  "SUI": "c10281",
  "SUY": "c21135",
  "SVQ": "c10440",
  "SVX": "c54",
  "SWT": "c11352",
  "SYD": "c10145",
  "SYS": "c22185",
  "SYX": "c20966",
  "SZG": "c10372",
  "TAS": "c10335",
  "TBS": "c10277",
  "TBW": "c13",
  "TGD": "c21611",
  "TGK": "c971",
  "TGP": "c20037",
  "THX": "c11313",
  "TIA": "c10374",
  "TJM": "c55",
  "TKM": "c9623667",
  "TLK": "c9776579",
  "TLL": "c11481",
  "TLS": "c10504",
  "TLT": "c240",
  "TLV": "c131",
  "TLY": "c22207",
  "TMJ": "c10338",
  "TOB": "c11175",
  "TOF": "c67",
  "TPE": "c10592",
  "TRN": "c10449",
  "TUU": "c36607",
  "TYO": "c10636",
  "UCT": "c10945",
  "UFA": "c172",
  "UGC": "c21105",
  "UIK": "c11273",
  "UKG": "c9623845",
  "UKK": "c10306",
  "UKX": "c20097",
  "ULK": "c11435",
  "ULN": "c10606",
  "ULY": "c195",
  "URJ": "c11192",
  "URS": "c8",
  "USK": "c10944",
  "USR": "c22194",
  "UTP": "c41725",
  "UUD": "c198",
  "UUS": "c23242",
  "VAQ": "c22025",
  "VAR": "c10381",
  "VCE": "c10451",
  "VEO": "c22039",
  "VGD": "c21",
  "VIE": "c10371",
  "VKT": "c10940",
  "VLC": "c10430",
  "VNO": "c11475",
  "VOG": "c38",
  "VOZ": "c193",
  "VRN": "c22240",
  "VSG": "c222",
  "VTB": "c154",
  "VUS": "c10854",
  "VVO": "c75",
  "WAS": "c87",
  "WAW": "c10472",
  "YAE": "c22019",
  "YKS": "c74",
  "ZAG": "c10507",
  "ZIX": "c21497",
  "ZKP": "c22202",
  "ZNZ": "c28047",
  "ZRH": "c10515"
    # –¥–æ–±–∞–≤–ª—è–π –ø–æ –º–µ—Ä–µ –Ω–∞–¥–æ–±–Ω–æ—Å—Ç–∏
}

iata_to_city.get("LED", "LED")

def parse_aviasales_url(url):
    if "avs.io" in url:
        try:
            r = requests.get(url, allow_redirects=False)
            url = r.headers["Location"]
        except:
            return "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞–∫–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É"

    match = re.search(r"([A-Z]{3})(\d{2})(\d{2})([A-Z]{3})(\d{2})?(\d{2})?", url)
    if not match:
        return "‚ùå –ù–µ–≤–µ—Ä–Ω–∞—è —Å—Å—ã–ª–∫–∞"

    from_iata, day, month, to_iata, return_day, return_month = match.groups()
    from_id = IATA_TO_YANDEX.get(from_iata)
    to_id = IATA_TO_YANDEX.get(to_iata)
    if not from_id or not to_id:
        return "‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –≥–æ—Ä–æ–¥"

    year = datetime.now().year
    depart_date = f"{year}-{month}-{day}"
    base = f"https://travel.yandex.ru/avia/search/result/?fromId={from_id}&toId={to_id}&when={depart_date}&adult_seats=1&children_seats=0&infant_seats=0&klass=economy"

    if return_day and return_month:
        return_date = f"{year}-{return_month}-{return_day}"
        base += f"&return_date={return_date}&oneway=2"
    else:
        base += f"&oneway=1"

    return f"üìç{to_iata} ‚Äî {day}.{month}\n{base}"

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    url = update.message.text.strip()
    result = parse_aviasales_url(url)
    await update.message.reply_text(result)

def main():
    app = ApplicationBuilder().token(BOT_TOKEN).build()
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    app.run_polling()

if __name__ == "__main__":
    main()
